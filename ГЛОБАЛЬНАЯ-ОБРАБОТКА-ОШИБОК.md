# Глобальная обработка ошибок

## Обзор

Создана централизованная система обработки ошибок для всего приложения.

## Обновленные компоненты

### 1. ProfileForm.vue ✅
- 400: "Пожалуйста, проверьте правильность заполнения полей"
- 401: "Сессия истекла. Пожалуйста, войдите снова"
- 403: "У вас нет прав для изменения этого профиля"
- 413: "Изображение слишком большое. Попробуйте другое фото"

### 2. PasswordChangeForm.vue ✅
- 400: "Неверный текущий пароль"
- 401: "Сессия истекла. Пожалуйста, войдите снова"

### 3. AvatarUpload.vue ✅
- Общая: "Не удалось обработать изображение. Попробуйте другой файл"

### 4. checkout.vue ✅
**Промокод:**
- 404: "Промокод не найден"
- 400: "Промокод недействителен или истек"

**Заказ:**
- 400: "Пожалуйста, проверьте правильность заполнения всех полей"
- 401: "Сессия истекла. Пожалуйста, войдите снова"
- 404: "Некоторые товары больше недоступны"
- 409: "Недостаточно товара на складе"

### 5. AddressManager.vue ✅
- Сохранение: "Не удалось сохранить адрес. Проверьте правильность заполнения полей"
- Удаление: "Не удалось удалить адрес. Попробуйте позже"

### 6. ReviewForm.vue ✅
- 409: "Вы уже оставили отзыв на этот товар"
- 401: "Пожалуйста, войдите в аккаунт чтобы оставить отзыв"
- 400: "Пожалуйста, заполните все поля корректно"

## Утилита errorHandler.ts

Создана централизованная утилита для обработки ошибок.

### Использование

```typescript
import { getUserFriendlyError, isNetworkError, getNetworkErrorMessage } from '~/utils/errorHandler';

try {
  await apiFetch('/api/endpoint');
} catch (err: any) {
  // Проверка сетевой ошибки
  if (isNetworkError(err)) {
    error.value = getNetworkErrorMessage();
    return;
  }
  
  // Получение понятного сообщения
  error.value = getUserFriendlyError(err, 'profile');
}
```

### Контексты

- `login` - авторизация
- `register` - регистрация
- `profile` - профиль
- `password` - смена пароля
- `order` - оформление заказа
- `promo` - промокоды
- `review` - отзывы
- `cart` - корзина

### Примеры

```typescript
// Профиль
getUserFriendlyError({ statusCode: 400 }, 'profile')
// → "Пожалуйста, проверьте правильность заполнения полей"

// Заказ
getUserFriendlyError({ statusCode: 409 }, 'order')
// → "Недостаточно товара на складе"

// Промокод
getUserFriendlyError({ statusCode: 404 }, 'promo')
// → "Промокод не найден"

// Без контекста (общее)
getUserFriendlyError({ statusCode: 500 })
// → "Ошибка сервера. Попробуйте позже"
```

## Коды ошибок

### Клиентские ошибки (4xx)

| Код | Общее сообщение | Специфичные по контексту |
|-----|-----------------|--------------------------|
| 400 | Неверные данные | profile: "Проверьте правильность полей"<br>password: "Неверный текущий пароль" |
| 401 | Сессия истекла | Везде: "Пожалуйста, войдите снова" |
| 403 | Нет доступа | profile: "Нет прав для изменения" |
| 404 | Не найдено | promo: "Промокод не найден"<br>order: "Товары недоступны" |
| 409 | Конфликт | order: "Недостаточно товара"<br>review: "Отзыв уже оставлен" |
| 413 | Слишком большой | profile: "Изображение слишком большое" |
| 422 | Не прошло валидацию | "Данные не прошли валидацию" |
| 429 | Слишком много запросов | "Подождите немного" |

### Серверные ошибки (5xx)

| Код | Сообщение |
|-----|-----------|
| 500 | Ошибка сервера. Попробуйте позже |
| 502 | Сервер временно недоступен |
| 503 | Сервис временно недоступен |

### Сетевые ошибки

```typescript
if (isNetworkError(err)) {
  // "Нет подключения к интернету. Проверьте соединение"
}
```

## Логирование

Все ошибки логируются в консоль для разработчиков:

```typescript
console.error("Profile update error:", err);
```

Это позволяет:
- ✅ Отлаживать в dev режиме
- ✅ Собирать логи в production (Sentry, LogRocket)
- ✅ Не показывать техническую информацию пользователю

## Принципы

### 1. Понятность
Сообщения написаны простым языком без технических терминов.

### 2. Конкретность
Указывается, что именно пошло не так и что делать.

### 3. Действие
Подсказывается следующий шаг (войти снова, проверить поля, попробовать позже).

### 4. Дружелюбность
Тон сообщений вежливый и поддерживающий.

## Примеры улучшений

### До
```
[PUT] "http://localhost:3001/users/2": 400 Bad Request
```

### После
```
Пожалуйста, проверьте правильность заполнения полей
```

---

### До
```
Error: Failed to fetch
```

### После
```
Нет подключения к интернету. Проверьте соединение
```

---

### До
```
Validation error: email must be an email
```

### После
```
Пожалуйста, проверьте правильность заполнения полей
```

## Будущие улучшения

### 1. Интеграция с Sentry

```typescript
import * as Sentry from "@sentry/vue";

catch (err: any) {
  Sentry.captureException(err, {
    tags: { context: 'profile' },
    extra: { userId: user.value?.id }
  });
  
  error.value = getUserFriendlyError(err, 'profile');
}
```

### 2. Retry механизм

```typescript
async function withRetry(fn: Function, retries = 3) {
  for (let i = 0; i < retries; i++) {
    try {
      return await fn();
    } catch (err) {
      if (i === retries - 1) throw err;
      await new Promise(r => setTimeout(r, 1000 * (i + 1)));
    }
  }
}
```

### 3. Offline режим

```typescript
if (!navigator.onLine) {
  return getNetworkErrorMessage();
}
```

### 4. Локализация

```typescript
export function getUserFriendlyError(
  error: ApiError,
  context?: string,
  locale = 'ru'
): string {
  // Поддержка разных языков
}
```

## Статус

✅ **Реализовано**

**Обновленные файлы:**
- ✅ ProfileForm.vue
- ✅ PasswordChangeForm.vue
- ✅ AvatarUpload.vue
- ✅ checkout.vue
- ✅ AddressManager.vue
- ✅ ReviewForm.vue
- ✅ errorHandler.ts (новая утилита)

**Дата обновления:** 31 октября 2025
