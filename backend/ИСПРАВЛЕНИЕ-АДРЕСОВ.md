# Исправление ошибки с адресами

## Проблема

При добавлении адреса возникала ошибка 500, потому что:
- API Gateway отправлял новые поля: `fullName`, `phone`, `addressLine1`, `addressLine2`
- User Service ожидал старые поля: `street`

## Что исправлено

### 1. Обновлены DTO в User Service

**Файлы:**
- `backend/apps/user-service/src/address/dto/create-address.dto.ts`
- `backend/apps/user-service/src/address/dto/update-address.dto.ts`

**Новые поля:**
```typescript
{
  userId: number;
  fullName: string;      // ФИО получателя
  phone: string;         // Телефон
  country: string;       // Страна
  city: string;          // Город
  state?: string;        // Регион (опционально)
  postalCode: string;    // Индекс
  addressLine1: string;  // Адрес (основная строка)
  addressLine2?: string; // Дополнительная информация
  isDefault?: boolean;   // Адрес по умолчанию
}
```

### 2. Улучшена обработка ошибок в API Gateway

**Файл:** `backend/apps/api-gateway/src/modules/address/address.service.ts`

Теперь все методы проверяют `response.success` и выбрасывают понятные ошибки.

## Как применить исправления

### Вариант 1: Перезапустить бэкенд

```bash
# Остановите текущий процесс (Ctrl+C)
# Затем запустите снова:
cd backend
npm run start:dev
```

### Вариант 2: Если используете Docker

```bash
cd backend
docker-compose down
docker-compose up --build
```

## Проверка работы

1. Запустите бэкенд
2. Откройте фронтенд
3. Войдите в систему
4. Перейдите в профиль → Адреса
5. Добавьте новый адрес

**Ожидаемый результат:**
- Адрес успешно создается
- Появляется уведомление "Адрес добавлен"
- Адрес отображается в списке

## Тестирование через API

```bash
# Создать адрес
curl -X POST http://localhost:3001/addresses \
  -H "Content-Type: application/json" \
  -d '{
    "userId": 1,
    "fullName": "Иван Иванов",
    "phone": "+79991234567",
    "country": "Россия",
    "city": "Москва",
    "postalCode": "123456",
    "addressLine1": "ул. Ленина, д. 10, кв. 5",
    "addressLine2": "Подъезд 2",
    "isDefault": true
  }'

# Получить адреса пользователя
curl http://localhost:3001/addresses/user/1
```

## Миграция базы данных (если нужно)

Если таблица `addresses` уже существует со старой структурой, выполните:

```sql
-- Добавить новые колонки
ALTER TABLE addresses ADD COLUMN IF NOT EXISTS full_name VARCHAR;
ALTER TABLE addresses ADD COLUMN IF NOT EXISTS phone VARCHAR;
ALTER TABLE addresses ADD COLUMN IF NOT EXISTS address_line1 VARCHAR;
ALTER TABLE addresses ADD COLUMN IF NOT EXISTS address_line2 VARCHAR;

-- Удалить старую колонку (если есть)
ALTER TABLE addresses DROP COLUMN IF EXISTS street;

-- Обновить NOT NULL ограничения
ALTER TABLE addresses ALTER COLUMN full_name SET NOT NULL;
ALTER TABLE addresses ALTER COLUMN phone SET NOT NULL;
ALTER TABLE addresses ALTER COLUMN address_line1 SET NOT NULL;
```

Или пересоздайте таблицу:

```sql
DROP TABLE IF EXISTS addresses;

CREATE TABLE addresses (
  id SERIAL PRIMARY KEY,
  user_id INTEGER NOT NULL,
  full_name VARCHAR NOT NULL,
  phone VARCHAR NOT NULL,
  country VARCHAR NOT NULL,
  city VARCHAR NOT NULL,
  state VARCHAR,
  postal_code VARCHAR NOT NULL,
  address_line1 VARCHAR NOT NULL,
  address_line2 VARCHAR,
  is_default BOOLEAN DEFAULT false,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_addresses_user_id ON addresses(user_id);
CREATE INDEX idx_addresses_is_default ON addresses(is_default);
```

## Готово! ✅

После перезапуска бэкенда адреса должны работать без ошибок.
