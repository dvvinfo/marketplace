# Улучшение обработки ошибок

## Проблема

Пользователям показывались технические ошибки:

```
[PUT] "http://localhost:3001/users/2": 400 Bad Request
```

Это:

- ❌ Непонятно для пользователя
- ❌ Раскрывает внутреннюю структуру API
- ❌ Выглядит непрофессионально
- ❌ Не помогает решить проблему

## Решение

Заменили технические ошибки на понятные человеческие сообщения.

## Изменения

### ProfileForm.vue

**Было:**

```typescript
catch (err: any) {
  error.value = err.message || "Не удалось обновить профиль";
}
```

**Стало:**

```typescript
catch (err: any) {
  console.error("Profile update error:", err); // Логируем для разработчиков

  // Показываем понятное сообщение пользователю
  if (err.statusCode === 400 || err.status === 400) {
    error.value = "Пожалуйста, проверьте правильность заполнения полей";
  } else if (err.statusCode === 401 || err.status === 401) {
    error.value = "Сессия истекла. Пожалуйста, войдите снова";
  } else if (err.statusCode === 403 || err.status === 403) {
    error.value = "У вас нет прав для изменения этого профиля";
  } else if (err.statusCode === 413 || err.status === 413) {
    error.value = "Изображение слишком большое. Попробуйте другое фото";
  } else {
    error.value = "Не удалось обновить профиль. Попробуйте позже";
  }
}
```

### PasswordChangeForm.vue

**Было:**

```typescript
catch (err: any) {
  error.value = err.message || "Не удалось изменить пароль";
}
```

**Стало:**

```typescript
catch (err: any) {
  console.error("Password change error:", err);

  if (err.statusCode === 400 || err.status === 400) {
    error.value = "Неверный текущий пароль";
  } else if (err.statusCode === 401 || err.status === 401) {
    error.value = "Сессия истекла. Пожалуйста, войдите снова";
  } else {
    error.value = "Не удалось изменить пароль. Попробуйте позже";
  }
}
```

### AvatarUpload.vue

**Было:**

```typescript
catch (err: any) {
  error.value = err.message || "Не удалось загрузить изображение";
}
```

**Стало:**

```typescript
catch (err: any) {
  console.error("Image processing error:", err);
  error.value = "Не удалось обработать изображение. Попробуйте другой файл";
}
```

## Сообщения об ошибках

### Коды ошибок и их сообщения

| Код | Техническое           | Пользовательское                                    |
| --- | --------------------- | --------------------------------------------------- |
| 400 | Bad Request           | Пожалуйста, проверьте правильность заполнения полей |
| 401 | Unauthorized          | Сессия истекла. Пожалуйста, войдите снова           |
| 403 | Forbidden             | У вас нет прав для изменения этого профиля          |
| 413 | Payload Too Large     | Изображение слишком большое. Попробуйте другое фото |
| 500 | Internal Server Error | Не удалось обновить профиль. Попробуйте позже       |

### Специфичные сообщения

**Смена пароля (400):**

```
"Неверный текущий пароль"
```

Вместо общего "Bad Request"

**Обработка изображения:**

```
"Не удалось обработать изображение. Попробуйте другой файл"
```

Вместо технической ошибки canvas

## Принципы хороших сообщений об ошибках

### 1. Понятность

✅ **Хорошо:** "Неверный текущий пароль"  
❌ **Плохо:** "Authentication failed: invalid credentials"

### 2. Конкретность

✅ **Хорошо:** "Изображение слишком большое. Попробуйте другое фото"  
❌ **Плохо:** "Ошибка загрузки"

### 3. Действие

✅ **Хорошо:** "Сессия истекла. Пожалуйста, войдите снова"  
❌ **Плохо:** "Ошибка 401"

### 4. Дружелюбность

✅ **Хорошо:** "Пожалуйста, проверьте правильность заполнения полей"  
❌ **Плохо:** "Validation error: invalid input"

## Логирование для разработчиков

Технические детали логируются в консоль:

```typescript
console.error("Profile update error:", err);
```

Это позволяет:

- ✅ Отлаживать проблемы в dev режиме
- ✅ Собирать логи в production
- ✅ Не показывать техническую информацию пользователю

## Примеры

### До улучшения

**Пользователь видит:**

```
[PUT] "http://localhost:3001/users/2": 400 Bad Request
```

**Проблемы:**

- Не понятно, что делать
- Видны технические детали
- Страшно и непрофессионально

### После улучшения

**Пользователь видит:**

```
Пожалуйста, проверьте правильность заполнения полей
```

**Преимущества:**

- Понятно, что нужно сделать
- Дружелюбно
- Профессионально

## Дополнительные улучшения

### 1. Валидация на клиенте

Предотвращаем ошибки до отправки:

```typescript
const schema = z.object({
  firstName: z.string().min(2, "Имя должно содержать минимум 2 символа"),
  // ...
});
```

### 2. Подсказки в реальном времени

```vue
<UFormField label="Имя" name="firstName" hint="Минимум 2 символа">
  <UInput v-model="state.firstName" />
</UFormField>
```

### 3. Визуальная обратная связь

```vue
<div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-xl">
  <div class="flex items-center gap-2">
    <UIcon name="i-heroicons-exclamation-circle" class="w-5 h-5" />
    {{ error }}
  </div>
</div>
```

### 4. Retry механизм

```typescript
async function retryRequest(fn: Function, retries = 3) {
  for (let i = 0; i < retries; i++) {
    try {
      return await fn();
    } catch (err) {
      if (i === retries - 1) throw err;
      await new Promise((resolve) => setTimeout(resolve, 1000 * (i + 1)));
    }
  }
}
```

### 5. Offline режим

```typescript
if (!navigator.onLine) {
  error.value = "Нет подключения к интернету. Проверьте соединение";
  return;
}
```

## Мониторинг ошибок

### Sentry / LogRocket

```typescript
import * as Sentry from "@sentry/vue";

catch (err: any) {
  // Отправляем в Sentry для мониторинга
  Sentry.captureException(err);

  // Показываем понятное сообщение пользователю
  error.value = "Не удалось обновить профиль. Попробуйте позже";
}
```

### Метрики

Отслеживать:

- Количество ошибок по типам
- Самые частые ошибки
- Время до ошибки
- Процент успешных операций

## Тестирование

### Сценарии

✅ **400 - Невалидные данные**

- Оставить поле пустым
- Проверить сообщение: "Пожалуйста, проверьте правильность заполнения полей"

✅ **401 - Истекшая сессия**

- Удалить токен из cookies
- Попробовать сохранить
- Проверить сообщение: "Сессия истекла. Пожалуйста, войдите снова"

✅ **413 - Большое изображение**

- Загрузить файл > 10MB
- Проверить сообщение: "Изображение слишком большое. Попробуйте другое фото"

✅ **500 - Ошибка сервера**

- Остановить бэкенд
- Попробовать сохранить
- Проверить сообщение: "Не удалось обновить профиль. Попробуйте позже"

✅ **Неверный пароль**

- Ввести неверный текущий пароль
- Проверить сообщение: "Неверный текущий пароль"

## Статус

✅ **Реализовано**

**Обновленные файлы:**

- ✅ ProfileForm.vue
- ✅ PasswordChangeForm.vue
- ✅ AvatarUpload.vue

**Дата обновления:** 31 октября 2025
