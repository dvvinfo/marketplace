# Исправление структуры данных корзины

## Проблема

При загрузке корзины на фронтенде возникала ошибка:
```
Cannot read properties of undefined (reading 'imageUrl')
```

Причина: бэкенд возвращал только базовую информацию о товарах в корзине (`productId`, `quantity`, `price`), но не включал полные данные о продукте (название, изображение и т.д.).

## Решение

### 1. Обновлен бэкенд (Order Service)

**Файл:** `backend/apps/order-service/src/cart/cart.service.ts`

Метод `getCartByUserId` теперь обогащает данные корзины информацией о продуктах:

```typescript
async getCartByUserId(userId: number): Promise<any> {
  // ... получаем корзину
  
  // Обогащаем данные корзины информацией о продуктах
  const enrichedItems = await Promise.all(
    cart.items.map(async (item) => {
      const productResponse = await firstValueFrom(
        this.productClient.send(RABBITMQ_PATTERNS.GET_PRODUCT, item.productId),
      );

      return {
        ...item,
        product: {
          id: productResponse.data.id,
          name: productResponse.data.title,
          title: productResponse.data.title,
          price: productResponse.data.price,
          image: productResponse.data.image,
          imageUrl: productResponse.data.image,
        },
      };
    }),
  );

  return {
    ...cart,
    items: enrichedItems,
  };
}
```

### 2. Обновлен фронтенд

**Файлы:**
- `frontend/app/pages/cart.vue`
- `frontend/app/pages/checkout.vue`
- `frontend/app/stores/cart.ts`

Добавлены вспомогательные функции для работы с разными структурами данных:

```typescript
const getItemName = (item: any) => {
  return item.product?.name || item.product?.title || item.name || 'Товар';
};

const getItemPrice = (item: any) => {
  return item.product?.price || item.price || 0;
};

const getItemImage = (item: any) => {
  return item.product?.imageUrl || item.product?.image || null;
};
```

## Структура данных корзины

### До исправления:
```json
{
  "id": 1,
  "userId": 1,
  "totalAmount": 1999.99,
  "items": [
    {
      "id": 1,
      "productId": 1,
      "quantity": 2,
      "price": 999.99,
      "subtotal": 1999.98
    }
  ]
}
```

### После исправления:
```json
{
  "id": 1,
  "userId": 1,
  "totalAmount": 1999.99,
  "items": [
    {
      "id": 1,
      "productId": 1,
      "quantity": 2,
      "price": 999.99,
      "subtotal": 1999.98,
      "product": {
        "id": 1,
        "name": "iPhone 15 Pro",
        "title": "iPhone 15 Pro",
        "price": 999.99,
        "image": "https://example.com/image.jpg",
        "imageUrl": "https://example.com/image.jpg"
      }
    }
  ]
}
```

## Преимущества

1. ✅ Фронтенд получает полную информацию о продуктах
2. ✅ Не нужны дополнительные запросы к Product Service
3. ✅ Единая структура данных для всех операций с корзиной
4. ✅ Обратная совместимость (вспомогательные функции на фронтенде)

## Тестирование

1. Перезапустите бэкенд:
```bash
cd backend
npm run start:dev
```

2. Откройте фронтенд: http://localhost:3000

3. Добавьте товары в корзину

4. Перейдите в корзину (`/cart`)

5. Проверьте, что:
   - Отображаются названия товаров
   - Отображаются изображения товаров
   - Отображаются цены
   - Работают кнопки изменения количества
   - Работает кнопка удаления

6. Перейдите к оформлению заказа (`/checkout`)

7. Проверьте, что товары отображаются корректно

## Результат

✅ Ошибка исправлена  
✅ Корзина работает корректно  
✅ Оформление заказа работает корректно  

---

**Дата:** 31 октября 2025  
**Статус:** ✅ Исправлено
