# Автообновление профиля после сохранения

## Как это работает

После успешного сохранения профиля данные автоматически обновляются во всех компонентах.

## Механизм обновления

### 1. Глобальное состояние (useState)

```typescript
// useAuth.ts
const user = useState<any>('user', () => null)
```

`useState` создает глобальное реактивное состояние, доступное во всем приложении.

### 2. Обновление данных

```typescript
// useAuth.ts
const fetchUser = async () => {
  if (!token.value) return
  
  try {
    user.value = await apiFetch('/auth/profile')
  } catch (error) {
    // Обработка ошибок
  }
}
```

Когда мы обновляем `user.value`, все компоненты автоматически реагируют.

### 3. Обработчик в profile.vue

```typescript
const handleProfileUpdate = async () => {
  // Обновляем данные пользователя из API
  await fetchUser();
  
  // Обновляем аватар из свежих данных
  avatarUrl.value = user.value?.avatar || null;
  
  toast.add({
    title: "Успешно!",
    description: "Профиль обновлен",
    color: "success",
  });
};
```

### 4. Автообновление в AppHeader

```typescript
// AppHeader.vue
const { user } = useAuth();

// Следим за изменением user
watch(
  user,
  (newVal) => {
    console.log("User changed:", newVal);
  },
  { deep: true }
);
```

Хедер автоматически обновляется при изменении `user`.

## Что обновляется

### 1. Страница профиля (profile.vue)

**Обновляется:**
- ✅ Имя и фамилия в боковом меню
- ✅ Email
- ✅ Аватар (превью)
- ✅ Все поля формы

**Как:**
```typescript
await fetchUser(); // Обновляет user.value
avatarUrl.value = user.value?.avatar || null; // Обновляет аватар
```

### 2. Хедер сайта (AppHeader.vue)

**Обновляется:**
- ✅ Имя пользователя
- ✅ Аватар

**Как:**
```vue
<UAvatar
  :src="user?.avatar || undefined"
  :alt="user?.nameFirst"
/>
{{ user?.nameFirst || "Аккаунт" }}
```

Автоматически реагирует на изменение `user`.

### 3. Другие компоненты

Любой компонент, использующий `useAuth()`, автоматически получит обновленные данные:

```typescript
const { user } = useAuth();

// user.value всегда актуален
console.log(user.value?.nameFirst);
```

## Поток данных

```
1. Пользователь нажимает "Сохранить изменения"
   ↓
2. ProfileForm отправляет PUT /users/:id
   ↓
3. Сервер обновляет данные в БД
   ↓
4. ProfileForm вызывает emit("update")
   ↓
5. profile.vue вызывает handleProfileUpdate()
   ↓
6. handleProfileUpdate вызывает fetchUser()
   ↓
7. fetchUser обновляет user.value из API
   ↓
8. Vue реактивность обновляет все компоненты:
   - profile.vue (форма, боковое меню)
   - AppHeader (имя, аватар)
   - Любые другие компоненты с useAuth()
```

## Примеры обновления

### Обновление имени

**До:**
```
Хедер: "Иван"
Профиль: "Иван Иванов"
```

**Пользователь меняет на "Петр"**

**После (автоматически):**
```
Хедер: "Петр"
Профиль: "Петр Иванов"
```

### Обновление аватара

**До:**
```
Хедер: [иконка пользователя]
Профиль: [иконка пользователя]
```

**Пользователь загружает фото**

**После (автоматически):**
```
Хедер: [фото пользователя]
Профиль: [фото пользователя]
```

## Преимущества

### 1. Автоматическая синхронизация
Не нужно вручную обновлять каждый компонент.

### 2. Единый источник истины
`user.value` - это единственное место, где хранятся данные пользователя.

### 3. Реактивность
Vue автоматически отслеживает изменения и обновляет UI.

### 4. Простота
Один вызов `fetchUser()` обновляет всё приложение.

## Отладка

### Логирование изменений

```typescript
// AppHeader.vue
watch(
  user,
  (newVal) => {
    console.log("User changed:", newVal);
  },
  { deep: true }
);
```

### Проверка обновления

1. Откройте DevTools → Console
2. Измените профиль
3. Нажмите "Сохранить изменения"
4. Увидите в консоли:
   ```
   User changed: { id: 1, nameFirst: "Петр", ... }
   ```

### Vue DevTools

1. Установите Vue DevTools
2. Откройте вкладку "Components"
3. Найдите AppHeader или profile
4. Посмотрите на `user` в props/data
5. Измените профиль
6. Увидите обновление в реальном времени

## Возможные проблемы

### Проблема: Хедер не обновляется

**Причина:** `fetchUser()` не вызывается или возвращает ошибку

**Решение:**
```typescript
const handleProfileUpdate = async () => {
  try {
    await fetchUser();
    console.log("User updated:", user.value);
  } catch (error) {
    console.error("Failed to fetch user:", error);
  }
};
```

### Проблема: Аватар не обновляется

**Причина:** `avatarUrl` не синхронизирован с `user.value.avatar`

**Решение:**
```typescript
const handleProfileUpdate = async () => {
  await fetchUser();
  avatarUrl.value = user.value?.avatar || null; // ✅ Обновляем аватар
};
```

### Проблема: Старые данные в форме

**Причина:** Форма не реагирует на изменение `props.user`

**Решение:**
```typescript
// ProfileForm.vue
watch(
  () => props.user,
  (newUser) => {
    if (newUser) {
      state.firstName = newUser.nameFirst || "";
      state.lastName = newUser.nameLast || "";
      // ...
    }
  }
);
```

## Тестирование

### Сценарии

✅ **Обновление имени**
1. Изменить имя в форме
2. Нажать "Сохранить изменения"
3. Проверить обновление в хедере
4. Проверить обновление в боковом меню

✅ **Обновление аватара**
1. Загрузить новый аватар
2. Нажать "Сохранить изменения"
3. Проверить обновление в хедере
4. Проверить обновление в профиле

✅ **Обновление нескольких полей**
1. Изменить имя, телефон, дату рождения
2. Нажать "Сохранить изменения"
3. Проверить, что всё обновилось
4. Обновить страницу
5. Проверить, что изменения сохранились

✅ **Ошибка обновления**
1. Отключить интернет
2. Попробовать сохранить
3. Проверить сообщение об ошибке
4. Проверить, что старые данные остались

## Статус

✅ **Реализовано**

**Обновленные файлы:**
- ✅ profile.vue - улучшен handleProfileUpdate
- ✅ AppHeader.vue - уже следит за user
- ✅ useAuth.ts - глобальное состояние

**Дата обновления:** 31 октября 2025
